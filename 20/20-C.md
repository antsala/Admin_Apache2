# Módulos.


El Servidor HTTP Apache es un programa modular en el que el administrador puede elegir la funcionalidad a incluir en el servidor seleccionando un conjunto de `módulos`. 

Los módulos se compilarán como ***Objetos Compartidos Dinámicos (DSOs)*** que existen por separado del archivo binario principal httpd. Los módulos DSO pueden compilarse en el momento en que se construye el servidor, o pueden compilarse y agregarse más tarde usando la Herramienta de Extensión Apache (apxs). Alternativamente, los módulos pueden compilarse estáticamente en el binario httpd cuando se construye el servidor.


El soporte DSO para cargar módulos individuales de Apache httpd se basa en un módulo llamado `MOD_SO`, que debe compilarse estáticamente en el núcleo de Apache. Es el único módulo además de `CORE` que no puede ponerse en un DSO en sí mismo. Prácticamente todos los otros módulos distribuidos de Apache son DSOs. 

Después de que un módulo se compile en un DSO llamado `mod_foo.so`, podemos usar la directiva `LOADMODULE` en el archivo `httpd.conf` o `apache.conf` para cargar este módulo al inicio o reinicio del servidor.

En Linux existe un mecanismo llamado ***enlace/carga dinámica de Objetos Compartidos Dinámicos (DSO)***, que proporciona una forma de construir un fragmento de código de programa en un formato especial para ***cargarlo en tiempo de ejecución*** en el espacio de direcciones de un programa ejecutable.

Esta carga generalmente se puede realizar de dos maneras: automáticamente por un programa del sistema llamado ```ld.so``` cuando se inicia un programa ejecutable, o manualmente desde dentro del programa en ejecución a través de una interfaz de sistema mediante las llamadas al sistema `dlopen()` / `dlsym()`.

En la primera forma, los DSO suelen llamarse ***bibliotecas compartidas*** o ***bibliotecas DSO*** y residen en un directorio del sistema (generalmente `/usr/lib`). Se codifica las referencias de la biblioteca en el archivo del programa ejecutable de Apache para que, en el momento de inicio, el cargador de Linux pueda colocar el DSO en ***/usr/lib***.

El programa ejecutable no necesita hacer nada por sí mismo para usar los símbolos del DSO porque la resolución completa la realiza el cargador de Linux. 

En la segunda forma, los DSO suelen llamarse ***objetos compartidos*** o ***archivos DSO*** y pueden tener un nombre con una extensión arbitraria (aunque generalmente la extensión es `.so`). Estos archivos suelen permanecer dentro de un directorio específico y no hay un enlace establecido automáticamente con el programa ejecutable donde se usan. 

En su lugar, el programa ejecutable carga manualmente el DSO en ***tiempo de ejecución*** en su espacio de direcciones a través de ***dlopen()***. 

El enfoque de biblioteca compartida es el típico, porque es para lo que se diseñó el mecanismo de DSO, por lo tanto, se utiliza para casi todos los tipos de bibliotecas que proporciona el sistema operativo.

Las características basadas en DSO mencionadas anteriormente tienen las siguientes ventajas:

- La gestión de Apache es más flexible en tiempo de ejecución porque el proceso del servidor puede ser ensamblado en tiempo de ejecución a través de directivas de configuración `LOADMODULE` en lugar de opciones de configuración en tiempo de compilación. 

- Apache puede ser fácilmente extendido con módulos de terceros incluso después de la instalación. 

## ¿Cómo cargamos los módulos?

Como hemos visto, Los DSO (Objetos Compartidos Dinámicos) son archivos que contienen código compilado que se puede cargar dinámicamente en un programa en tiempo de ejecución. En el contexto de Apache, los DSO se refieren a los módulos que ***extienden la funcionalidad del servidor web de Apache***. Estos módulos pueden proporcionar diversas características, como soporte para diferentes protocolos, seguridad adicional, capacidades de procesamiento de contenido dinámico, entre otros.

Los módulos de Apache son componentes de software que pueden ser agregados o eliminados para personalizar y extender las capacidades del servidor web Apache según nuestras necesidades. 

Supongamos que queremos habilitar el módulo de compresión de salida en Apache. Este módulo, llamado `mod_deflate`, comprime la respuesta HTTP antes de enviarla al cliente, lo que puede mejorar significativamente el rendimiento del sitio web. Para configurar este módulo como un DSO en Apache, seguiremos estos pasos:

Primero debemos comprobar que el módulo `mod_deflate` esté disponible en nuestra instalación de Apache. Por lo general, los módulos precompilados se encuentran en un directorio como `/usr/lib/apache2/modules/`.

![mod_deflate](../img/20/202403251151.png)

Posteriormente, en el archivo de configuración principal de Apache, generalmente `httpd.conf` o `apache.conf`, añadimos la línea `LoadModule deflate_module modules/mod_deflate.so`, que carga el módulo `mod_deflate` como un DSO en el servidor Apache.

```apache
# Cargar el módulo mod_deflate
LoadModule deflate_module modules/mod_deflate.so

# Configuración del módulo mod_deflate
<IfModule mod_deflate.c>
    # Habilita la compresión de salida
    SetOutputFilter DEFLATE

    # Configura los tipos MIME que se van a comprimir
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json

    # Opcional: Configura los niveles de compresión
    DeflateCompressionLevel 9
</IfModule>
```

En esta configuración, el comando `LoadModule` se utiliza para cargar el módulo `mod_deflate.so`. Luego, dentro de la directiva `<IfModule mod_deflate.c>`, se especifican las opciones de configuración para el módulo ***mod_deflate***.

- `SetOutputFilter DEFLATE` Habilita la compresión de salida para todas las respuestas del servidor.

- `AddOutputFilterByType DEFLATE` Especifica los tipos MIME de los archivos que se deben comprimir.

- `DeflateCompressionLevel` Configura el nivel de compresión.

Después de agregar esta configuración al archivo de configuración de Apache, guardamos y cerramos el archivo, y luego reiniciamos el servidor Apache para que los cambios surtan efecto. Esto se puede hacer utilizando el comando:

```
sudo systemctl restart apache2
```

Con esta configuración, hemos cargado el módulo mod_deflate.so y habilitado la compresión de contenido en nuestro servidor Apache. 

Apache ofrece una cantidad muy importante de módulos, alguno de ellos no lo usaremos nunca, pero, por el contrario, otros si serán de nuestros interés. A continuación te ofrecemos un resumen de los más útiles y cómo configurarlos.


## Módulo mod_rewrite.


`mod_rewrite`: Este módulo permite la manipulación y redirección de URLs de manera flexible y poderosa. Se utiliza comúnmente para implementar reglas de reescritura de URL, redireccionamiento de páginas y gestión de enlaces permanentes.

Este es un ejemplo de uso.

```apache
# Cargar el módulo mod_rewrite
LoadModule rewrite_module modules/mod_rewrite.so

# Habilitar el uso de mod_rewrite
RewriteEngine On

# Redirigir todas las solicitudes HTTP a HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
```

- `LoadModule rewrite_module modules/mod_rewrite.so`: Esta línea carga el módulo `mod_rewrite` en Apache.

- `RewriteEngine On`: Habilita el motor de reescritura de URL para procesar reglas de redirección.

- `RewriteCond %{HTTPS} off`: Esta condición verifica si la solicitud no se realizó a través de HTTPS.

- `RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]`: Esta regla redirige todas las solicitudes que no utilizan HTTPS a la misma URL pero utilizando HTTPS. El flag `[L,R=301]` indica que esta es la última regla a aplicar y que se debe enviar un código de redirección HTTP 301 (Movido permanentemente) al cliente.

Con esta configuración, todas las solicitudes HTTP serán redirigidas automáticamente a través de HTTPS. Como este módulo es muy importante, vamos a dedicarle un apartado en exclusiva más adelante.

## Módulo mod_ssl

Proporciona soporte para SSL/TLS y cifrado seguro en las comunicaciones web. Este módulo es esencial para habilitar conexiones seguras a través de HTTPS.

Antes de configurar SSL en Apache, debemos asegurarnos de que el módulo `mod_ssl` esté habilitado mediante un comando de carga de módulo en el archivo de configuración.

```apache
LoadModule ssl_module modules/mod_ssl.so
```

El resto de la configuración de SSL se realiza en una sección `VirtualHost`, como podemos ver a continuación.

```apache
Listen 443

<VirtualHost *:443>
    ServerName example.com
    ServerAdmin webmaster@example.com

    DocumentRoot /var/www/html

    SSLEngine on
    SSLCertificateFile /ruta/a/tu/certificado.crt
    SSLCertificateKeyFile /ruta/a/tu/clave_privada.key

    # Opcional: Configura otros parámetros de SSL, como el protocolo y los cifrados admitidos
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
    SSLHonorCipherOrder on

    # Configuración adicional, como reglas de reescritura, restricciones de acceso, etc.
    # ...

</VirtualHost>
```

- `Listen 443`: Indica a Apache que escuche en el puerto 443, el puerto predeterminado para HTTPS.

- `<VirtualHost *:443>`: Define un host virtual para conexiones SSL en el puerto 443.

- `ServerName`: Especifica el nombre del servidor para este host virtual.

- `ServerAdmin`: Dirección de correo electrónico del administrador del servidor.

- `DocumentRoot`: Directorio raíz para este host virtual.

- `SSLEngine on`: Habilita el motor SSL para este host virtual.

- `SSLCertificateFile`: Ruta al archivo de certificado SSL.

- `SSLCertificateKeyFile`: Ruta al archivo de clave privada correspondiente al certificado.

- `SSLProtocol`: Configura los protocolos SSL/TLS permitidos.

- `SSLCipherSuite`: Configura los algoritmos de cifrado permitidos.

- `SSLHonorCipherOrder`: Especifica si se debe respetar el orden de preferencia del cliente para los cifrados.

- Otras configuraciones opcionales pueden incluir reglas de reescritura, restricciones de acceso, etc.

Recuerda que debemos reemplazar `/ruta/a/tu/certificado.crt` y `/ruta/a/tu/clave_privada.key` con las rutas reales a los archivos del certificado y clave privada.

Después de realizar estas configuraciones, guardamos los cambios en el archivo de configuración de Apache y reiniciamos el servidor Apache para que los cambios surtan efecto.

3. **mod_deflate:** Permite la compresión de contenido para reducir el tamaño de los archivos servidos por el servidor Apache. La compresión de contenido puede mejorar significativamente el rendimiento del sitio web al reducir el ancho de banda necesario para transferir archivos.

4. **mod_proxy:** Habilita la funcionalidad de proxy en Apache, permitiendo redireccionar solicitudes HTTP a otros servidores. Este módulo es útil para configurar Apache como un servidor proxy inverso o como parte de una configuración de balanceo de carga.

5. **mod_proxy_http:** Proporciona soporte específico para la redirección de solicitudes HTTP a través de un servidor proxy. Este módulo es necesario cuando se utiliza Apache como servidor proxy para manejar solicitudes HTTP.

6. **mod_headers:** Permite la manipulación de encabezados HTTP tanto en las solicitudes entrantes como en las respuestas salientes. Este módulo es útil para configurar políticas de seguridad, establecer encabezados personalizados y controlar el almacenamiento en caché de contenido.

7. **mod_expires:** Permite controlar las cabeceras de expiración de cache en el servidor Apache, lo que facilita el control de la duración de la cache del navegador para los recursos del sitio web.

8. **mod_auth_basic:** Proporciona autenticación básica HTTP en Apache, permitiendo proteger ciertos directorios o archivos con un nombre de usuario y una contraseña.

9. **mod_autoindex:** Genera automáticamente listados de directorios para los directorios que no tienen un archivo de índice específico. Este módulo es útil para mostrar el contenido de los directorios en el navegador cuando no se proporciona un archivo de índice explícito.

Estos son solo algunos ejemplos de los módulos más utilizados en Apache. La elección de los módulos a utilizar dependerá de los requisitos específicos de tu sitio web y de la funcionalidad que desees implementar en tu servidor Apache.




[Vamos al siguiente contenido](./20-D.md)