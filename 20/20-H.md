# SSL en Apache.


Configurar certificados digitales en Apache es un proceso fundamental para habilitar la comunicación segura a través del protocolo HTTPS. Los pasos a seguir son los siguientes:

1. **Obtén un Certificado Digital**:
   - Podemos obtener un certificado digital de una Autoridad de Certificación (CA) confiable, como Let's Encrypt, o comprar uno de una empresa emisora de certificados.
   - Los certificados digitales se almacenan en archivos con distintas extensiones.
   Las extensiones de los archivos de certificados digitales indican el formato del archivo y el contenido que contienen. Aquí hay algunas extensiones comunes utilizadas para diferentes tipos de certificados digitales:

      1. **.cer** o **.crt**:
         - Estas extensiones se utilizan típicamente para certificados en formato X.509 codificados en base64.
         - Estos archivos contienen la `clave pública` y la información del titular del certificado.

      2. **.pem**:
         - Este formato es un estándar de codificación de certificados digitales que puede contener tanto certificados como `claves privadas`.
         - Los archivos PEM están en formato de texto base64, lo que los hace legibles para los humanos.

      3. **.p12** o **.pfx**:
         - Estas extensiones se utilizan para archivos de contenedores de `PKCS #12`.
         - Un archivo P12 o PFX puede contener un certificado digital junto con su `clave privada` y, opcionalmente, `certificados intermedios`.

      4. **.key**:
         - Esta extensión se usa comúnmente para archivos que contienen `claves privadas`.
         - Los archivos `.key` pueden estar en formato `PEM` o en otros formatos específicos del proveedor de servicios.

      5. **.csr**:
         - Esta extensión se asocia comúnmente con solicitudes de firma de certificados (Certificate Signing Requests, CSR).
         - Un archivo `.csr` contiene información sobre la entidad que solicita un certificado y la clave pública asociada.

      6. **.der**:
         - Este formato representa certificados digitales codificados en DER (Distinguished Encoding Rules).
         - Los archivos DER son ***binarios y no legibles para humanos***, a diferencia de los archivos PEM.

2. **Prepara los Archivos del Certificado**:
   - Una vez que obtengas el certificado digital, necesitarás preparar los archivos necesarios.
   - Por lo general, necesitarás tres archivos: el ***certificado público***, la ***clave privada*** y, opcionalmente, el archivo de la ***cadena de certificación*** (si se proporciona).
   - Asegúrate de que la clave privada esté protegida y ***solo sea accesible por el usuario que ejecuta el servidor web*** (por ejemplo, el usuario Apache).

3. **Configuración de Apache**:
   - Accede al archivo de configuración de Apache (`httpd.conf`, `apache.conf` o archivos `.conf` en la carpeta `sites-available`).
   - Asegúrate de que el módulo `mod_ssl` esté habilitado. Puedes hacerlo utilizando el comando `a2enmod ssl` 
   - Localiza la sección donde se define el virtual host para tu sitio web y agrega o modifica las siguientes directivas apropiadas.

4. **Verificación y Reinicio del Servidor Apache**:
   - Antes de reiniciar el servidor Apache, asegúrate de que la configuración esté libre de errores utilizando el comando `apachectl configtest`.
   - Si la prueba de configuración es exitosa, reinicia Apache usando el comando `sudo systemctl restart apache2`.

5. **Prueba del Certificado SSL**:
   - Accede a tu sitio web utilizando `https://` en lugar de `http://`.
   - Deberías ver el candado SSL en la barra de direcciones del navegador, lo que indica que la conexión es segura.

## Instalación de un certificado digital de Let's Encrypt.

Como no dispondremos de un dominio real de DNS, utilizaremos como nombre de host `localhost`. En un escenario real, debemos poner el dominio DNS del servidor.

Para realizar una instalación manual del certificado en el servidor Apache, realizamos los siguientes pasos.

Si deseas solicitar un certificado para `localhost`, puedes seguir estos pasos modificados:

### Paso 1: Instalación de Let's Encrypt

1. Abre una terminal en tu servidor Apache.

2. Clona el repositorio de Let's Encrypt desde GitHub utilizando el siguiente comando:
   ```
   git clone https://github.com/letsencrypt/letsencrypt
   ```

### Paso 2: Generación del certificado

3. Navega al directorio de Let's Encrypt:
   ```
   cd letsencrypt
   ```

4. Detén el servidor Apache temporalmente:
   ```
   sudo systemctl stop apache2
   ```

5. Genera el certificado utilizando el siguiente comando:
   ```
   ./certbot-auto certonly --standalone -d localhost
   ```

### Paso 3: Configuración de Apache

6. Crea un nuevo archivo de configuración SSL para `localhost`:
   ```
   sudo nano /etc/apache2/sites-available/localhost-ssl.conf
   ```

   Y agrega la siguiente configuración:
   ```
   <VirtualHost *:443>
       ServerName localhost

       SSLEngine on
       SSLCertificateFile /etc/letsencrypt/live/localhost/fullchain.pem
       SSLCertificateKeyFile /etc/letsencrypt/live/localhost/privkey.pem

       DocumentRoot /var/www/html

       ErrorLog ${APACHE_LOG_DIR}/error.log
       CustomLog ${APACHE_LOG_DIR}/access.log combined
   </VirtualHost>
   ```

7. Habilita el nuevo sitio SSL y modifica la configuración de Apache:
   ```
   sudo a2ensite localhost-ssl.conf
   sudo a2enmod ssl
   ```

8. Verifica la configuración de Apache:
   ```
   sudo apachectl configtest
   ```

9. Si la prueba de configuración es exitosa, reinicia Apache para aplicar los cambios:
   ```
   sudo systemctl restart apache2
   ```

### Paso 4: Automatización de la renovación

10. Let's Encrypt emite certificados con una validez de 90 días. Puedes configurar una tarea cron para renovar automáticamente el certificado antes de que expire.

11. Abre el archivo cron para editar:
    ```
    sudo crontab -e
    ```

12. Agrega la siguiente línea al final del archivo para programar la renovación del certificado:
    ```
    0 0 * * 0 /path/to/letsencrypt/certbot-auto renew --quiet
    ```

    Esto renovará el certificado todos los domingos a la medianoche. Asegúrate de reemplazar `/path/to/letsencrypt/certbot-auto` con la ubicación real de tu certbot.

¡Listo! Has configurado manualmente un certificado de Let's Encrypt para `localhost` en tu servidor Apache sin usar Certbot. Recuerda automatizar la renovación del certificado para mantenerlo actualizado.

## Instalación del certificado usando certbot.


      
[Vamos al siguiente contenido](./20-I.md)